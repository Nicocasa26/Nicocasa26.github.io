<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Capacitación | CONEMAT</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f8;
      padding: 40px;
    }

    .card {
      max-width: 720px;
      margin: auto;
      background: #ffffff;
      padding: 30px;
      border-radius: 8px;
      text-align: center;
    }

    input {
      width: 100%;
      padding: 10px;
      margin-bottom: 12px;
      font-size: 14px;
    }

    button {
      width: 100%;
      padding: 12px;
      background: #0d6efd;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 15px;
      margin-top: 10px;
    }

    iframe {
      width: 100%;
      height: 315px;
      border: none;
      margin-top: 20px;
    }

    .error {
      color: #b91c1c;
      margin-top: 15px;
      font-weight: bold;
    }

    .success {
      background: #d4edda;
      padding: 12px;
      border-radius: 6px;
      color: #155724;
      margin-top: 15px;
    }

    .legal {
      font-size: 0.85em;
      margin-top: 10px;
      color: #555;
      text-align: left;
    }

    hr {
      margin: 25px 0;
    }
  </style>
</head>
<body>

<div class="card" id="contenido">
  <p>Cargando capacitación...</p>
</div>

<script>
/* ================= SUPABASE ================= */
const SUPABASE_URL = "https://brdekhbqophvcobhxdgc.supabase.co";
const SUPABASE_KEY = "sb_publishable_CTkAN6flGJDQGVYV2VDUTg_Ov8CuhXn";
const { createClient } = supabase;
const client = createClient(SUPABASE_URL, SUPABASE_KEY);

/* ================= PARAMS ================= */
const params = new URLSearchParams(window.location.search);
const token = params.get("token");
const contenedor = document.getElementById("contenido");

/* ================= STATE ================= */
let capacitacionEmpresaId = null;
let empresaNombre = "";
let videoURL = "";
let tituloCapacitacion = "";

/* ================= HELPERS ================= */
function youtubeEmbed(url) {
  const id = url.includes("youtu.be")
    ? url.split("youtu.be/")[1]
    : url.split("v=")[1];
  return `https://www.youtube.com/embed/${id}`;
}

/* ================= CARGA ================= */
async function cargarCapacitacion() {

  if (!token) {
    contenedor.innerHTML = "<p class='error'>Link inválido.</p>";
    return;
  }

  const { data, error } = await client
    .from("capacitaciones_empresas")
    .select(`
      id,
      finalizada,
      fecha_vencimiento,
      empresas ( nombre ),
      capacitaciones_base ( nombre, url_video )
    `)
    .eq("link_publico", token)
    .single();

  if (error || !data) {
    contenedor.innerHTML = "<p class='error'>Capacitación no encontrada.</p>";
    return;
  }

  if (data.finalizada) {
    contenedor.innerHTML = `
      <h2>Capacitación finalizada</h2>
      <p>Esta capacitación ya fue cerrada.</p>
      <p>Para más información, comuníquese con su empresa.</p>
    `;
    return;
  }

  capacitacionEmpresaId = data.id;
  empresaNombre = data.empresas.nombre;
  videoURL = data.capacitaciones_base.url_video;
  tituloCapacitacion = data.capacitaciones_base.nombre;

  mostrarFormulario(data.fecha_vencimiento);
}

/* ================= FORMULARIO ================= */
function mostrarFormulario(vencimiento) {
  contenedor.innerHTML = `
    <h2>${tituloCapacitacion} – CONEMAT</h2>
    <p><strong>Empresa:</strong> ${empresaNombre}</p>
    <p><strong>Vigente hasta:</strong> ${vencimiento}</p>

    <hr>

    <h3>Registro obligatorio</h3>

    <input type="text" id="nombre" placeholder="Apellido y Nombre">
    <input type="text" id="dni" placeholder="DNI (7 u 8 dígitos)">
    <input type="text" id="puesto" placeholder="Puesto / Tarea">

    <div class="legal">
      <input type="checkbox" id="declaracion">
      Declaro que los datos ingresados son verídicos y que participé de la capacitación.
    </div>

    <button onclick="registrar()">Registrar y acceder</button>

    <div id="mensaje"></div>
  `;
}

/* ================= REGISTRAR ================= */
async function registrar() {
  const nombre = document.getElementById("nombre").value.trim();
  const dni = document.getElementById("dni").value.trim().replace(/\D/g, "");
  const puesto = document.getElementById("puesto").value.trim();
  const declaracion = document.getElementById("declaracion").checked;
  const mensaje = document.getElementById("mensaje");

  mensaje.innerHTML = "";

  if (!nombre || !dni || !puesto || !declaracion) {
    mensaje.innerHTML = "<div class='error'>Complete todos los campos.</div>";
    return;
  }

  if (dni.length < 7 || dni.length > 8) {
    mensaje.innerHTML = "<div class='error'>DNI inválido.</div>";
    return;
  }

  const { data: existente } = await client
    .from("asistentes")
    .select("nombre")
    .eq("dni", dni)
    .eq("capacitacion_id", capacitacionEmpresaId)
    .maybeSingle();

  if (existente) {
    mensaje.innerHTML = `
      <div class="error">
        ${existente.nombre} ya se encuentra registrado en esta capacitación.
      </div>
    `;
    return;
  }

  const { error } = await client.from("asistentes").insert([{
    nombre,
    dni,
    puesto,
    empresa: empresaNombre,
    capacitacion_id: capacitacionEmpresaId,
    declaracion_aceptada: true
  }]);

  if (error) {
    mensaje.innerHTML = "<div class='error'>Error al registrar.</div>";
    return;
  }

  mostrarVideo();
}

/* ================= VIDEO ================= */
function mostrarVideo() {
  contenedor.innerHTML = `
    <h2>${tituloCapacitacion} – CONEMAT</h2>
    <p><strong>Empresa:</strong> ${empresaNombre}</p>

    <iframe src="${youtubeEmbed(videoURL)}" allowfullscreen></iframe>

    <div class="success">
      Registro confirmado. Puede visualizar la capacitación.
    </div>
  `;
}

/* ================= INIT ================= */
cargarCapacitacion();
</script>

</body>
</html>
